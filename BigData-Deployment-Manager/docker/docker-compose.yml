version: '3.8'

services:
  # PostgreSQL database for source data
  postgres:
    image: postgres:13
    container_name: deployment-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: netops_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - deployment-net

  # Apache Spark Master
  spark-master:
    image: bitnami/spark:3.5.0
    container_name: deployment-spark-master
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8080:8080"  # Spark Master Web UI
      - "7077:7077"  # Spark Master Port
    networks:
      - deployment-net

  # Apache Spark Worker
  spark-worker:
    image: bitnami/spark:3.5.0
    container_name: deployment-spark-worker
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=4G
      - SPARK_WORKER_CORES=4
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    depends_on:
      - spark-master
    networks:
      - deployment-net

  # Hive Metastore (using embedded Derby)
  hive-metastore:
    image: apache/hive:3.1.3
    container_name: deployment-hive-metastore
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      SERVICE_OPTS: "-Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://postgres:5432/metastore_db -Djavax.jdo.option.ConnectionUserName=postgres -Djavax.jdo.option.ConnectionPassword=postgres"
    ports:
      - "9083:9083"  # Thrift server port
    depends_on:
      - postgres
    networks:
      - deployment-net

  # Flask API
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: deployment-api
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=development
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=netops_db
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - SPARK_MASTER=spark://spark-master:7077
    depends_on:
      - postgres
      - spark-master
      - hive-metastore
    volumes:
      - ../api:/app/api
      - ../config:/app/config
    networks:
      - deployment-net

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: deployment-redis
    ports:
      - "6379:6379"
    networks:
      - deployment-net

networks:
  deployment-net:
    driver: bridge

volumes:
  postgres_data:
